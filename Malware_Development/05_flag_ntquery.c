/*
    Anti-Debugging - Check NTQuery ProcessDebugFlag
    28 Jan 2025
    Eric

    To build: x86_64-w64-mingw32-gcc 05_flag_ntquery.c -o ntquery_flag.exe -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc
*/

#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <stdbool.h>

typedef NTSTATUS(NTAPI *fNtQueryInformationProcess)(
  IN HANDLE           ProcessHandle,
  IN DWORD            ProcessInformationClass,
  OUT PVOID           ProcessInformation,
  IN ULONG            ProcessInformationLength,
  OUT PULONG          ReturnLength
);

// Function to check if a debugger is present
bool DebuggerCheck() {
  BOOL result;
  DWORD rProcDebugFlags;
  DWORD returned;
  const DWORD ProcessDebugFlags = 0x1f; // not documented in below link
  HMODULE nt = LoadLibraryA("ntdll.dll");
  // https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess
  fNtQueryInformationProcess myNtQueryInformationProcess = (fNtQueryInformationProcess)
  GetProcAddress(nt, "NtQueryInformationProcess");
  myNtQueryInformationProcess(GetCurrentProcess(), ProcessDebugFlags,
    &rProcDebugFlags, sizeof(DWORD), &returned);
  if (0 == rProcDebugFlags){
    MessageBox(NULL, "Debugger Detected", "Program", MB_OK);
    return 1;  // exit if a debugger is present
  }
  return result;
}

// Function that simulates the main functionality
void hack() {
  MessageBox(NULL, "Malicious Code", "Program", MB_OK);
}

int main() {
  // Check if a debugger is present
  DebuggerCheck();
  // Main functionality
  hack();
  return 0;
}