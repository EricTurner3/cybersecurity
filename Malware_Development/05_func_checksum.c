/*
    Anti-Debugging - Breakpoint Detection / Checksum
    28 Jan 2025
    Eric

    To build: x86_64-w64-mingw32-g++ -O2 05_func_checksum.c -o Breakpoint.exe -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive -lpsapi 

*/

#include <windows.h>
#include <stdio.h>

DWORD CalcFuncCrc(PUCHAR funcBegin, PUCHAR funcEnd) {
  DWORD crc = 0;
  for (; funcBegin < funcEnd; ++funcBegin) {
    crc += *funcBegin;
  }
  return crc;
}


// prevent compiler from making functions embedded
#pragma auto_inline(off)
VOID DebuggeeFunction() {
  printf("Hello World");
}

VOID DebuggeeFunctionEnd() {}; // stub function trick to detect end of our func we are calculating crc of

#pragma auto_inline(on)

// to calculate this value, the program needs compiled and executed
// monitor the output of the crc in the console, and update the value here
// thus, if the code is modified in anyway
// then the crc no longer will match and it will flag
// one example is a breakpoint, which injects an int 3h / 0xCC opcode into the function
// this would destroy the integrity of the checksum
DWORD g_origCrc = 0x4db; 

int main() {
  DWORD crc = CalcFuncCrc((PUCHAR)DebuggeeFunction, (PUCHAR)DebuggeeFunctionEnd);
  printf("crc: 0x%x (%ld)", crc, crc);
  if (g_origCrc != crc) {
    MessageBox(NULL, "Breakpoint detected", "Debug Check", MB_OK);
    return -1;
  }
  MessageBox(NULL, "Running as usual", "Debug Check", MB_OK);
  return 0;
}