/*
    Anti-VM - VirtualBox File Detect
    15 Feb 2025
    Eric

    To build: x86_64-w64-mingw32-g++ -O2 06_vbox_file_detect.c -o VBoxFile.exe -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive

*/

#include <windows.h>
#include <stdio.h>

BOOL checkVM() {
  // Paths to check
  const char* paths[] = {
    "c:\\windows\\system32\\drivers\\VBoxMouse.sys",
    "c:\\windows\\system32\\drivers\\VBoxGuest.sys",
    "c:\\windows\\system32\\drivers\\VBoxSF.sys",
    "c:\\windows\\system32\\drivers\\VBoxVideo.sys",
    "c:\\windows\\system32\\vboxdisp.dll",
    "c:\\windows\\system32\\vboxhook.dll",
    "c:\\windows\\system32\\vboxservice.exe",
    "c:\\windows\\system32\\vboxtray.exe"
  };

  // placeholder, default to FALSE
  BOOL vm_detected = FALSE;

  // loop through the filepaths to see if any exist
  for (size_t i = 0; i < (sizeof(paths) / sizeof(paths[0])); ++i){
    DWORD attributes = GetFileAttributes(paths[i]);
    if (attributes != INVALID_FILE_ATTRIBUTES && !(attributes & FILE_ATTRIBUTE_DIRECTORY)){
      printf("VirtualBox File Found: %s \n", paths[i]);
      vm_detected = TRUE;
      break;
    }
  }
	return vm_detected;
  
}
int main() {
  if (checkVM()) {
    printf("The system appears to be a virtual machine.\n");
  } else {
    printf("The system does not appear to be a virtual machine.\n");
  }
  return 0;
}